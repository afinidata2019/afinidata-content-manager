dist: xenial   # required for Python >= 3.7
language: python
python:
  - "3.7"
services:
  - mysql
env:
  - CM_DATABASE_NAME='cm_db' CM_DATABASE_ENGINE='django.db.backends.mysql' CM_DATABASE_USER='root' CM_DATABASE_PASSWORD='' \
    CM_DATABASE_HOST='localhost' CM_DATABASE_PORT='3306' CM_DATABASE_USERS_NAME='user_db' CM_DATABASE_USERS_ENGINE='django.db.backends.mysql'
before_install:
  - mysql -e 'CREATE DATABASE cm_db;'
  - mysql -e 'CREATE DATABASE user_db;'
install:
  - pip install -r requirements.txt
  - pip install .
# command to run tests
script:
  - python manage.py makemigrations
  - python manage.py makemigrations --database=messenger_users_db
  - python manage.py migrate auth
  - python manage.py migrate --database=default
  - python manage.py migrate --database=messenger_users_db
  # https://stackoverflow.com/questions/6244382/how-to-automate-createsuperuser-on-django
  - python manage.py shell -c "from django.contrib.auth.models import User; User.objects.create_superuser('admin', 'admin@example.com', 'adminpass')"
  - python manage.py test --keepdb
# Push the results back to codecov
after_success:
  - codecov